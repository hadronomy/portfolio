---
import { getCollection } from 'astro:content';
import { MobileMenu } from '~/components/react/MobileMenu';
import { TerminalPath, type FileNode } from '~/components/react/TerminalPath';
import ThemeToggle from '~/components/ThemeToggle.astro';

const { class: className, ...props } = Astro.props;
const pathname = Astro.url.pathname;
const isHome = pathname === '/' || pathname === '';

// --- Construct File Tree ---
const posts = await getCollection('blog');
const blogChildren: FileNode[] = posts
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .map(post => ({
    name: post.id + (post.id.endsWith('.mdx') ? '' : '.mdx'),
    path: `/blog/${post.id}`,
    type: 'file'
  }));

const fileTree: FileNode = {
  name: '~',
  path: '/',
  type: 'dir',
  children: [
    {
      name: 'blog',
      path: '/blog',
      type: 'dir',
      children: blogChildren
    },
    {
      name: 'experiments',
      path: '/experiments',
      type: 'dir',
      children: [] 
    },
    {
      name: 'rss.xml',
      path: '/rss.xml',
      type: 'file'
    },
    {
      name: 'cv.pdf',
      path: '/cv.pdf',
      type: 'file'
    }
  ]
};
---

<header 
  class:list={[
    'sticky top-0 z-50 w-full h-20 border-b border-white/20 bg-[#050505]/90 backdrop-blur-md',
    className
  ]} 
  {...props}
>
  <!-- Background Grid -->
  <div class="absolute inset-0 bg-[linear-gradient(to_right,rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(to_bottom,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:4rem_4rem] pointer-events-none z-0"></div>

  <!-- Layout Container -->
  <div class="relative z-10 h-full w-full flex items-center justify-between px-4 sm:px-6">
    
    <!-- LEFT: Path & Mobile Menu -->
    <div class="flex-1 flex items-center min-w-0 mr-4 gap-4">
      
      <!-- Mobile Menu Trigger -->
      <div class="lg:hidden shrink-0">
        <MobileMenu 
          client:load
          currentPath={pathname}
          externalLinks={[
            { label: 'GitHub', href: 'https://github.com/hadronomy', icon: 'github' },
            { label: 'RSS', href: '/rss.xml', icon: 'rss' }
          ]}
        />
      </div>

      <!-- Interactive Breadcrumbs -->
      <div class="hidden md:block w-full max-w-2xl">
        <TerminalPath 
          client:load 
          initialPathname={pathname} 
          fileTree={fileTree} 
        />
      </div>

    </div>

    <!-- CENTER: System Title -->
    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-0 hidden lg:flex items-center justify-center pointer-events-none select-none">
      <div class="flex items-center gap-3 opacity-30">
        <div class="w-1 h-1 bg-white rounded-full"></div>
        <span class="font-mono text-[10px] font-bold uppercase tracking-[0.4em] text-white">
          {isHome ? 'System_Root' : 'Directory_View'}
        </span>
        <div class="w-1 h-1 bg-white rounded-full"></div>
      </div>
    </div>

    <!-- RIGHT: Actions -->
    <div class="flex-none flex items-center justify-end gap-4 pl-4">
      
      <!-- Clock -->
      <div id="clock-widget" class="hidden xl:flex items-center gap-3 text-white/40 select-none border-r border-white/10 pr-4">
        <span class="text-[10px] font-mono time-display tabular-nums">00:00:00</span>
      </div>

      <!-- Navigation & Tools -->
      <div class="flex items-center gap-2">
        <a 
          id="navbar-contextual-btn" 
          href={pathname.startsWith('/blog') ? '/' : '/blog'}
          class="hidden sm:flex items-center gap-2 h-8 px-3 border border-white/10 hover:border-white/40 hover:bg-white/5 font-mono text-[10px] font-bold uppercase tracking-widest text-muted-foreground hover:text-white transition-all duration-200"
        >
          <span>{pathname.startsWith('/blog') ? 'Return' : '/Blog'}</span>
        </a>

        <div class="w-8 h-8 flex items-center justify-center border border-white/10 hover:border-white/40 hover:bg-white/5 transition-colors text-muted-foreground hover:text-white">
           <ThemeToggle />
        </div>
      </div>
    </div>

  </div>

  <div class="absolute bottom-0 left-0 w-full h-[1px] bg-white/5"></div>

</header>

<script>
  function updateClock() {
    const timeDisplay = document.querySelector('.time-display');
    if (timeDisplay) {
      const now = new Date();
      timeDisplay.textContent = now.toLocaleTimeString('en-US', { hour12: false });
    }
  }

  document.addEventListener('astro:page-load', () => {
    updateClock();
    setInterval(updateClock, 1000);
  });
</script>