---
import type { MarkdownHeading } from 'astro'; // Import type
import { Icon } from 'astro-icon/components';
import type { CollectionEntry } from 'astro:content';
import { format } from 'date-fns';

import MainLayout from '~/layouts/Main.astro';

type Props = CollectionEntry<'blog'>['data'] & {
  remarkPluginFrontmatter: Record<string, any>;
  headings: MarkdownHeading[]; // Receive headings
};

const { title, description, pubDate, remarkPluginFrontmatter, headings } = Astro.props;
const { duration } = remarkPluginFrontmatter;

function formatDuration(duration: number) {
  const seconds = Math.ceil(duration / 1000);
  const minutes = Math.ceil(seconds / 60);
  return `${minutes} min read`;
}

const baseItems = [
  { label: '00. Metadata', id: 'post-header', depth: 1 },
];

const contentItems = headings
  // Filter out h1 (usually title) and anything too deep (h4+)
  .filter(h => h.depth > 1 && h.depth < 4)
  .map(h => ({
    label: h.text,
    id: h.slug,
    depth: h.depth
  }));

const footerItems = [
  { label: 'End of File', id: 'post-footer', depth: 1 }
];

// Combine
const postSidebar = [...baseItems, ...contentItems, ...footerItems];
---

<MainLayout title={title} description={description} sidebarItems={postSidebar}>
  
  <article class="flex flex-col min-h-screen">
    
    <!-- Post Header -->
    <header id="post-header" class="relative p-8 md:p-16 border-b border-white/20 bg-white/5 overflow-hidden">
      <!-- Clean Repeating Diagonal Stripes -->
      <div class="absolute inset-0 opacity-10 pointer-events-none" 
           style="background-image: repeating-linear-gradient(45deg, #ffffff 0, #ffffff 1px, transparent 0, transparent 50%); background-size: 10px 10px;">
      </div>

      <div class="relative z-10 flex flex-col gap-6">
        <!-- Meta Data -->
        <div class="flex flex-wrap items-center gap-4 font-mono text-xs uppercase tracking-widest text-muted-foreground">
          <div class="flex items-center gap-2 px-3 py-1 border border-white/10 bg-black/40">
            <Icon name="tabler:calendar" class="w-4 h-4" />
            <time datetime={format(pubDate, 'yyyy-MM-dd')}>
              {format(new Date(pubDate), 'dd MMM yyyy')}
            </time>
          </div>
          <div class="flex items-center gap-2 px-3 py-1 border border-white/10 bg-black/40">
            <Icon name="tabler:clock" class="w-4 h-4" />
            <span>{formatDuration(duration)}</span>
          </div>
        </div>

        <h1 class="text-3xl md:text-5xl lg:text-6xl font-black uppercase tracking-tighter leading-tight text-white">
          {title}
        </h1>
        
        <p class="text-lg md:text-xl text-muted-foreground font-mono border-l-2 border-green-500/50 pl-6 max-w-3xl">
          {description}
        </p>
      </div>
    </header>

    <!-- Post Content -->
    <!-- Note: We ensure headings have IDs (Astro MDX does this automatically) -->
    <div id="post-content" class="p-8 md:p-12 w-full max-w-none">
      <div class="prose prose-invert prose-lg prose-mono w-full max-w-4xl mx-auto
           prose-headings:font-bold prose-headings:uppercase prose-headings:tracking-tight prose-headings:scroll-mt-32
           prose-p:text-muted-foreground prose-p:leading-relaxed
           prose-a:text-green-400 prose-a:no-underline hover:prose-a:underline
           prose-code:text-white prose-code:bg-white/10 prose-code:px-1 prose-code:py-0.5 prose-code:rounded-none prose-code:before:content-none prose-code:after:content-none
           prose-pre:bg-transparent prose-pre:p-0 prose-pre:m-0 prose-pre:border-0 prose-pre:rounded-none
           prose-blockquote:border-l-2 prose-blockquote:border-white/20 prose-blockquote:bg-white/5 prose-blockquote:py-2 prose-blockquote:px-6 prose-blockquote:not-italic
           prose-img:rounded-none prose-img:border prose-img:border-white/20
           ">
        <slot />
      </div>
    </div>

    <!-- Article Footer -->
    <footer id="post-footer" class="p-8 md:p-12 border-t border-white/20 mt-auto opacity-60">
      <div class="flex items-center justify-between font-mono text-xs uppercase tracking-widest">
         <span>End of File</span>
         <span>Hash: {Math.random().toString(36).substring(7).toUpperCase()}</span>
      </div>
    </footer>

  </article>
</MainLayout>